---
- name: Configuration serveur multifonction LPIC-2
  hosts: servers
  become: true
  vars_files:
    - vars.yml
    
  tasks:
    # === PRÉPARATION ===
    - name: Mise à jour du système
      apt:
        update_cache: yes
        upgrade: dist
        
    - name: Installation des paquets nécessaires
      apt:
        name:
          - isc-dhcp-server
          - samba
          - samba-common-bin
          - iptables-persistent
          - nginx              # BONUS: Serveur web intranet
          - rsync              # BONUS: Sauvegarde optimisée
          - cron               # BONUS: Planification sauvegarde
        state: present

    # === DHCP ===
    - name: Configuration DHCP
      template:
        src: templates/dhcp.conf.j2
        dest: /etc/dhcp/dhcpd.conf
        backup: yes
      notify: restart dhcp

    - name: Activation du service DHCP
      systemd:
        name: isc-dhcp-server
        enabled: yes
        state: started

    # === SAMBA ===
    - name: Création du groupe compta
      group:
        name: compta
        state: present

    - name: Création des répertoires de partage
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
        owner: root
        group: root
      loop:
        - "{{ public_dir }}"
        - "{{ compta_dir }}"

    - name: Configuration Samba
      template:
        src: templates/smb.conf.j2
        dest: /etc/samba/smb.conf
        backup: yes
      notify: restart samba

    - name: Création des utilisateurs Samba
      shell: |
        useradd -M -s /usr/sbin/nologin {{ item.name }} || true
        {% if item.groups %}usermod -a -G {{ item.groups }} {{ item.name }}{% endif %}
        echo -e "{{ item.password }}\n{{ item.password }}" | smbpasswd -a -s {{ item.name }}
      loop: "{{ samba_users }}"
      no_log: true

    # === FIREWALL ===
    - name: Création du script firewall
      template:
        src: templates/firewall.sh.j2
        dest: /opt/firewall.sh
        mode: '0755'

    - name: Application du firewall
      shell: /opt/firewall.sh

    # === BONUS: NGINX INTRANET ===
    - name: Création du répertoire web intranet
      file:
        path: /var/www/intranet
        state: directory
        mode: '0755'
        owner: www-data
        group: www-data

    - name: Configuration nginx intranet
      template:
        src: templates/nginx-intranet.conf.j2
        dest: /etc/nginx/sites-available/intranet
      notify: restart nginx

    - name: Activation du site intranet
      file:
        src: /etc/nginx/sites-available/intranet
        dest: /etc/nginx/sites-enabled/intranet
        state: link
      notify: restart nginx

    - name: Désactivation du site par défaut nginx
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: restart nginx

    - name: Création de la page d'accueil intranet
      template:
        src: templates/intranet-index.html.j2
        dest: /var/www/intranet/index.html
        owner: www-data
        group: www-data
        mode: '0644'

    # === BONUS: SAUVEGARDE AUTOMATIQUE ===
    - name: Création du répertoire de sauvegarde
      file:
        path: /backup
        state: directory
        mode: '0750'
        owner: root
        group: root

    - name: Création du script de sauvegarde
      template:
        src: templates/backup.sh.j2
        dest: /opt/backup.sh
        mode: '0755'
        owner: root
        group: root

    - name: Configuration cron pour sauvegarde quotidienne
      cron:
        name: "Sauvegarde quotidienne Samba"
        minute: "0"
        hour: "2"
        job: "/opt/backup.sh"
        user: root

    # === VÉRIFICATIONS ===
    - name: Vérification des services
      systemd:
        name: "{{ item }}"
        state: started
        enabled: yes
      loop:
        - isc-dhcp-server
        - smbd
        - nmbd
        - nginx

  handlers:
    - name: restart dhcp
      systemd:
        name: isc-dhcp-server
        state: restarted

    - name: restart samba
      systemd:
        name: smbd
        state: restarted
      listen: restart samba
      
    - name: restart nmbd
      systemd:
        name: nmbd
        state: restarted
      listen: restart samba

    - name: restart nginx
      systemd:
        name: nginx
        state: restarted